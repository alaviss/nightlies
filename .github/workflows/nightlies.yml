name: Nightlies
on:
  push:
    branches:
      - master
      - actions
  pull_request:
    branches:
      - master
      - actions
  schedule:
    - cron: '0 0 * * *'

jobs:
  build:
    strategy:
      matrix:
        branch: [devel, version-1-2]
        target:
          - os: android
            osarch: arm64
          - os: linux
            osarch: armv6
          - os: linux
            osarch: armv7a
          - os: linux
            osarch: armv7
          - os: linux
            osarch: armv64
          - os: linux
            osarch: 32
          - os: linux
            osarch: 64
          - os: macos
            osarch: 64
          - os: windows
            osarch: 32
          - os: windows
            osarch: 64
        include:
          - target:
              os: android
            builder: ubuntu-18.04
          - target:
              os: linux
            builder: ubuntu-18.04
          - target:
              os: macos
            builder: macos-10.15
          - target:
              os: windows
            builder: windows-2019
    name: '${{ matrix.target.os }} (${{ matrix.osarch }})'
    runs-on: ${{ matrix.builder }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Checkout Nim
        uses: actions/checkout@v2
        with:
          repository: nim-lang/Nim
          ref: ${{ matrix.branch }}
          path: nim
      - name: Checkout csources
        uses: actions/checkout@v2
        with:
          repository: nim-lang/csources
          path: nim/csources

      - name: Install node.js
        uses: actions/setup-node@v1
        with:
          node-version: 8.x
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo DEBIAN_FRONTEND='noninteractive' apt-fast install -yq \
            libcurl4-openssl-dev libsdl1.2-dev libgc-dev libsfml-dev
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: brew install boehmgc sfml gnu-tar node
      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir dist
          curl -L "https://nim-lang.org/download/mingw$ARCH-6.3.0.7z" -o "dist/mingw${ARCH}.7z"
          7z x "dist/mingw$ARCH.7z" -odist
